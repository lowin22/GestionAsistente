@page "/mostrar-badge"
@using GestionAsistente.BlazorUI.Controlador
@using GestionAsistente.Entidades
@rendermode InteractiveServer
<h3>MostrarBadge</h3>

<div class="col-md-12 col-xs-12 col-sm-12" style="text-align: center; overflow-y: auto; top: 0px; left: 0px;">
    <div class="table-responsive col-md-12 col-xs-12 col-sm-12" style="text-align: center; overflow-y: auto;">
        <table class="table table-bordered">
            <thead style="text-align: center;">
                <tr style="text-align: center">
                    <th>Acciones</th>
                    <th>Número Badge</th>
                    <th>Accesos</th>
                    <th>Horario</th>
                    <th>Unidad</th>
                    <th>Ocupado</th>
                </tr>
            </thead>
            <tbody>
                @if (listaBadge != null)

                {
                    @foreach (var badge in listaBadge)
                    {
                        <tr>
                            <td>
                                <button class="btn" data-bs-toggle="modal" data-bs-target="#ModificarBadge" @onclick="() => seleccionarEditarUsuario(badge.BadgeID)">
                                    <!-- Icono SVG para editar -->
                                    <svg width="16" height="16" fill="currentColor" class="bi bi-pen" viewBox="0 0 16 16">
                                        <path d="m13.498.795.149-.149a1.207 1.207 0 1 1 1.707 1.708l-.149.148a1.5 1.5 0 0 1-.059 2.059L4.854 14.854a.5.5 0 0 1-.233.131l-4 1a.5.5 0 0 1-.606-.606l1-4a.5.5 0 0 1 .131-.232l9.642-9.642a.5.5 0 0 0-.642.056L6.854 4.854a.5.5 0 1 1-.708-.708L9.44.854A1.5 1.5 0 0 1 11.5.796a1.5 1.5 0 0 1 1.998-.001m-.644.766a.5.5 0 0 0-.707 0L1.95 11.756l-.764 3.057 3.057-.764L14.44 3.854a.5.5 0 0 0 0-.708z" />
                                    </svg>
                                </button>
                                <button class="btn" data-bs-toggle="modal" data-bs-target="#ConfirmarEliminar" @onclick="() => seleccionarBadgeEliminar(badge.BadgeID)">
                                    <!-- Icono SVG para eliminar -->
                                    <svg width="16" height="16" fill="currentColor" class="bi bi-trash3" viewBox="0 0 16 16" >
                                        <path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5M11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 1 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47M8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5" />
                                    </svg>
                                </button>
                            </td>
                            <td>@badge.BadgeID</td>
                            <td>@badge.Accesos</td>
                            <td>@badge.Horario</td>
                            <td>@badge.Unidad?.Nombre</td>
                            <td>@(badge.Ocupado ? "Sí" : "No")</td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="3">No hay badges registrados</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>


<div class="modal fade" id="ConfirmarEliminar" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header text-center">
                <h5 class="modal-title" id="ConfirmarEliminar">¿Eliminar Encargado?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <p class="fs-5">Esta acción no se puede deshacer.</p>
                <p class="text-danger">¿Estás seguro de que deseas eliminar este encargado?</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button class="btn btn-primary" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button class="btn btn-danger" data-bs-dismiss="modal" @onclick="() => EliminarBadge(eliminarBadge.BadgeID)">
                    Confirmar
                </button>

            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="ModificarBadge" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ModificarBadge">Actualizar Badge</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <EditForm Model="badge" OnValidSubmit="ModificarBadge" FormName="modificarBadgeForm">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="mb-3">
                        <label for="accesos" class="form-label">Accesos</label>
                        <InputText id="accesos" class="form-control" @bind-Value="badge.Accesos" />
                    </div>

                    <div class="mb-3">
                        <label for="horaInicio">Hora de Inicio</label>
                        <InputSelect id="horaInicio" class="form-select" @bind-Value="horaInicio">
                            <option value="">Seleccione la hora de inicio</option>
                            @foreach (var hora in horasDelDiaInicio)
                            {
                                <option value="@hora">@hora</option>
                            }
                        </InputSelect>
                    </div>


                    <div class="mb-3">
                        <label for="horaFinal">Hora de Final</label>
                        <InputSelect id="horaFinal" class="form-select" @bind-Value="horaFinal">
                            <option value="">Seleccione la hora de finalización</option>
                            @foreach (var hora in horasDelDiaFinal)
                            {
                                <option value="@hora">@hora</option>
                            }
                        </InputSelect>
                    </div>

                    <div class="mb-3">
                        <label for="unidadID" class="form-label">Unidad</label>
                        <InputSelect id="unidadID" class="form-control" @bind-Value="badge.UnidadID">
                            @foreach (var unidad in listaUnidades)
                            {
                                <option value="@unidad.UnidadID">@unidad.Nombre</option>
                            }
                        </InputSelect>
                    </div>
                       

                    <button type="submit" class="btn btn-primary" data-bs-dismiss="modal">Actualizar badge</button>
                </EditForm>
                @if (mensajeExito != null)
                {
                    <div class="alert alert-success">
                        @mensajeExito
                    </div>
                }
                @if (mensajeError != null)
                {
                    <div class="alert alert-danger">
                        @mensajeError
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    UnidadControlador unidadControlador = new UnidadControlador();

    BadgeControlador badgeControlador = new BadgeControlador();

    string horaInicio, horaFinal = "", horario;
    string mensajeExito;
    string mensajeError;

    List<Badge> listaBadge = new List<Badge>();

    List<Unidad> listaUnidades = new List<Unidad>();

    Badge badge = new Badge
        {
            Unidad = new Unidad()
        };

    Badge actualizarBadge = new Badge
        {
            Unidad = new Unidad()
        };

    Badge eliminarBadge = new Badge
        {
            Unidad = new Unidad()
        };

    // Lista de horas (de 7 a 20)
    private List<string> horasDelDiaInicio = new()
    {
        "07:00",
        "08:00",
        "09:00",
        "10:00",
        "11:00",
        "12:00",
        "13:00",
        "14:00",
        "15:00",
        "16:00",
        "17:00",
        "18:00"
    };
    private List<string> horasDelDiaFinal = new()
    {
        "07:00",
        "08:00",
        "09:00",
        "10:00",
        "11:00",
        "12:00",
        "13:00",
        "14:00",
        "15:00",
        "16:00",
        "17:00",
        "18:00"
    };

    protected override async Task OnInitializedAsync()

    {

        listaBadge = await badgeControlador.ListarBadge();

        if (listaBadge == null)
        {
            listaBadge = new List<Badge>(); // Initialize to prevent null reference
        }

        listaUnidades = await unidadControlador.ListarUnidades();

    }

    private async Task seleccionarBadgeEliminar(int eliminarBadges)
    {
        eliminarBadge = listaBadge.FirstOrDefault(x => x.BadgeID == eliminarBadges);
    }

    async Task EliminarBadge(int badgeID)
    {
        await badgeControlador.EliminarBadge(badgeID);

        listaBadge = await badgeControlador.ListarBadge();

        StateHasChanged();
    }

    async Task seleccionarEditarUsuario(int badgeID)
    {

        actualizarBadge = listaBadge.Find(b => b.BadgeID == badgeID);

        badge.Accesos = actualizarBadge.Accesos;
        badge.UnidadID = actualizarBadge.UnidadID;
        badge.Horario = actualizarBadge.Horario;
        badge.BadgeID = actualizarBadge.BadgeID;

    }

    private async Task ModificarBadge()
    {

        try
        {

            bool exito = false;
            badge.Horario = horaInicio + " a " + horaFinal;

            exito = await badgeControlador.ActualizarBadge(badge);

            listaBadge = await badgeControlador.ListarBadge();


            if (exito)
            {
                mensajeExito = "Badge registrado con éxito.";
                mensajeError = null;

            }
            else
            {
                mensajeExito = null;
                mensajeError = "Hubo un problema al registrar el badge.";
            }

        }
        catch (Exception ex)
        {
            mensajeError = $"Error: {ex.Message}";
            mensajeExito = null;
        }

        StateHasChanged();
    }

}
