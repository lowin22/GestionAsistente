@page "/mostrar-badge"
@using GestionAsistente.BlazorUI.Components.Layout
@using GestionAsistente.BlazorUI.Controlador
@using GestionAsistente.BlazorUI.Data
@using GestionAsistente.Entidades
@using System.Security.Claims
@using Microsoft.AspNetCore.Identity
@rendermode InteractiveServer
@layout LayoutPrincipal
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject RoleManager<IdentityRole> RolManager

<h3>MostrarBadge</h3>

<div class="col-md-12 col-xs-12 col-sm-12" style="text-align: center; overflow-y: auto; top: 0px; left: 0px;">
    <div class="table-responsive col-md-12 col-xs-12 col-sm-12" style="text-align: center; overflow-y: auto;">
        <table class="table table-bordered">
            <thead style="text-align: center;">
                <tr style="text-align: center">
                    <th>Acciones</th>
                    <th>Número Badge</th>
                    <th>Horario</th>
                    <th>Unidad</th>
                    <th>Ocupado</th>
                    <th>Justificación</th>
                </tr>
                @* <tr>
                    <th>
                        <input type="search" @bind="badgeABuscar" @oninput="BusquedaAsincrona" placeholder="Buscar por número de badge" style="width: 100%;" />
                    </th>
                </tr> *@
            </thead>
            <tbody>
                <tr> 
                <th></th>
                <th>
                    <input type="search" @bind="badgeABuscar" @oninput="BusquedaAsincrona" placeholder="Buscar por número de badge" style="width: 80%; text-align:center" />
                </th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                </tr>
                

                @if (string.IsNullOrEmpty(badgeABuscar))
                {
                    

                    @foreach (var badge in listaBadgePaginacion)
                    {
                        <tr>
                            <td>
                            <button class="btn" data-bs-toggle="modal" data-bs-target="#ModificarBadge" @onclick="() => seleccionarEditarBadge(badge.BadgeID)">
                                    <!-- Icono SVG para editar -->
                                    <svg width="16" height="16" fill="currentColor" class="bi bi-pen" viewBox="0 0 16 16">
                                        <path d="m13.498.795.149-.149a1.207 1.207 0 1 1 1.707 1.708l-.149.148a1.5 1.5 0 0 1-.059 2.059L4.854 14.854a.5.5 0 0 1-.233.131l-4 1a.5.5 0 0 1-.606-.606l1-4a.5.5 0 0 1 .131-.232l9.642-9.642a.5.5 0 0 0-.642.056L6.854 4.854a.5.5 0 1 1-.708-.708L9.44.854A1.5 1.5 0 0 1 11.5.796a1.5 1.5 0 0 1 1.998-.001m-.644.766a.5.5 0 0 0-.707 0L1.95 11.756l-.764 3.057 3.057-.764L14.44 3.854a.5.5 0 0 0 0-.708z" />
                                    </svg>
                                </button>
                                <button class="btn" data-bs-toggle="modal" data-bs-target="#ConfirmarEliminar" @onclick="() => seleccionarBadgeEliminar(badge.BadgeID)">
                                    <!-- Icono SVG para eliminar -->
                                    <svg width="16" height="16" fill="currentColor" class="bi bi-trash3" viewBox="0 0 16 16">
                                        <path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5M11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 1 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47M8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5" />
                                    </svg>
                                </button>
                            </td>
                            <td>@badge.BadgeID</td>
                            <td>@badge.Horario</td>
                            <td>@badge.Unidad?.Nombre</td>
                            <td>@(badge.Ocupado ? "Sí" : "No")</td>
                            <td>@badge.Justificacion</td>
                        </tr>
                    }
                }
                else if (badgesBuscar != null && badgesBuscar.Any())
                {
                    @foreach (var badge in badgesBuscar)
                    {
                        <tr>
                            <td>
                            <button class="btn" data-bs-toggle="modal" data-bs-target="#ModificarBadge" @onclick="() => seleccionarEditarBadge(badge.BadgeID)">
                                    <!-- Icono SVG para editar -->
                                    <svg width="16" height="16" fill="currentColor" class="bi bi-pen" viewBox="0 0 16 16">
                                        <path d="m13.498.795.149-.149a1.207 1.207 0 1 1 1.707 1.708l-.149.148a1.5 1.5 0 0 1-.059 2.059L4.854 14.854a.5.5 0 0 1-.233.131l-4 1a.5.5 0 0 1-.606-.606l1-4a.5.5 0 0 1 .131-.232l9.642-9.642a.5.5 0 0 0-.642.056L6.854 4.854a.5.5 0 1 1-.708-.708L9.44.854A1.5 1.5 0 0 1 11.5.796a1.5 1.5 0 0 1 1.998-.001m-.644.766a.5.5 0 0 0-.707 0L1.95 11.756l-.764 3.057 3.057-.764L14.44 3.854a.5.5 0 0 0 0-.708z" />
                                    </svg>
                                </button>
                                <button class="btn" data-bs-toggle="modal" data-bs-target="#ConfirmarEliminar" @onclick="() => seleccionarBadgeEliminar(badge.BadgeID)">
                                    <!-- Icono SVG para eliminar -->
                                    <svg width="16" height="16" fill="currentColor" class="bi bi-trash3" viewBox="0 0 16 16">
                                        <path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5M11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 1 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47M8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5" />
                                    </svg>
                                </button>
                            </td>
                            <td>@badge.BadgeID</td>
                            <td>@badge.Horario</td>
                            <td>@badge.Unidad?.Nombre</td>
                            <td>@(badge.Ocupado ? "Sí" : "No")</td>
                            <td>@badge.Justificacion</td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="6">No se encontraron resultados</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>
<div class="modal fade" id="ConfirmarEliminar" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header text-center">
                <h5 class="modal-title" id="ConfirmarEliminar">¿Eliminar Encargado?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <p class="fs-5">Esta acción no se puede deshacer.</p>
                <p class="text-danger">¿Estás seguro de que deseas eliminar este encargado?</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button class="btn btn-primary" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button class="btn btn-danger" data-bs-dismiss="modal" @onclick="() => EliminarBadge(eliminarBadge.BadgeID)">
                    Confirmar
                </button>

            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="ModificarBadge" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ModificarBadge">Actualizar Badge</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <EditForm Model="badge" OnValidSubmit="ModificarBadge" FormName="modificarBadgeForm">

                    <div class="mb-3">
                        <label for="horaInicio">Hora de Inicio</label>
                        <InputSelect id="horaInicio" class="form-select" @bind-Value="horaInicio">
                            <option value="">Seleccione la hora de inicio</option>
                            @foreach (var hora in horasDelDiaInicio)
                            {
                                <option value="@hora">@hora</option>
                            }
                        </InputSelect>
                    </div>


                    <div class="mb-3">
                        <label for="horaFinal">Hora de Final</label>
                        <InputSelect id="horaFinal" class="form-select" @bind-Value="horaFinal">
                            <option value="">Seleccione la hora de finalización</option>
                            @foreach (var hora in horasDelDiaFinal)
                            {
                                <option value="@hora">@hora</option>
                            }
                        </InputSelect>
                    </div>

                    <div class="mb-3">
                        <label for="unidadID" class="form-label">Unidad</label>
                        <InputSelect id="unidadID" class="form-control" @bind-Value="badge.UnidadID">
                            <option value="">Sin unidad</option>
                            @foreach (var unidad in listaUnidades)
                            {
                                <option value="@unidad.UnidadID">@unidad.Nombre</option>
                            }
                        </InputSelect>
                    </div>
                       

                    <button type="submit" class="btn btn-primary" data-bs-dismiss="modal">Actualizar badge</button>
                </EditForm>
                @if (mensajeExito != null)
                {
                    <div class="alert alert-success">
                        @mensajeExito
                    </div>
                }
                @if (mensajeError != null)
                {
                    <div class="alert alert-danger">
                        @mensajeError
                    </div>
                }
            </div>
        </div>
    </div>
</div>
<div class="mt-3 text-center">
    <button @onclick="() => CambiarPagina(currentPage - 1)" class="btn btn-secondary" disabled="@(currentPage == 1)">
        Anterior
    </button>
    <span class="mx-2">Página @currentPage de @totalPages</span>
    <button @onclick="() => CambiarPagina(currentPage + 1)" class="btn btn-secondary" disabled="@(currentPage == totalPages)">
        Siguiente
    </button>
</div>
@code {

    private AuthenticationState authState;
    private ClaimsPrincipal usuarioAutenticado;
    private string nombreUsuarioAutenticado;
    private ApplicationUser usuarioIdentity;

    UnidadControlador unidadControlador = new UnidadControlador();

    BadgeControlador badgeControlador = new BadgeControlador();

    string horaInicio, horaFinal = "", horario;
    string mensajeExito;
    string mensajeError;
    string simboloRangoHoras = "a";
    private string badgeABuscar;
    private List<Badge> badgesBuscar = new List<Badge>();

    List<Badge> listaBadge = new List<Badge>();

    List<Badge> listaBadgePaginacion = new List<Badge>();

    List<Unidad> listaUnidades = new List<Unidad>();

    private HistorialAccionesControlador historialAccionesControlador = new HistorialAccionesControlador();
    private HistorialAcciones historialAcciones = new HistorialAcciones
    {
    };

    // Propiedades de paginación
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalItems;
    private int totalPages;

    Badge badge = new Badge
        {
            Unidad = new Unidad()
        };

    Badge actualizarBadge = new Badge
        {
            Unidad = new Unidad()
        };

    Badge eliminarBadge = new Badge
        {
            Unidad = new Unidad()
        };

    // Lista de horas (de 7 a 20)
    private List<string> horasDelDiaInicio = new()
    {
        "07:00",
        "08:00",
        "09:00",
        "10:00",
        "11:00",
        "12:00",
        "13:00",
        "14:00",
        "15:00",
        "16:00",
        "17:00"
    };

    private List<string> horasDelDiaFinal = new()
    {

        "07:00",
        "08:00",
        "09:00",
        "10:00",
        "11:00",
        "12:00",
        "13:00",
        "14:00",
        "15:00",
        "16:00",
        "17:00",
        "18:00"

    };

    private List<string> horasDelDiaCompletas = new()
    {

        "07:00",
        "08:00",
        "09:00",
        "10:00",
        "11:00",
        "12:00",
        "13:00",
        "14:00",
        "15:00",
        "16:00",
        "17:00",
        "18:00"

    };

    protected override async Task OnInitializedAsync()
    {
        authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        usuarioAutenticado = authState.User;

        // Comprobar si el usuario está autenticado y asignar valores
        if (usuarioAutenticado.Identity?.IsAuthenticated ?? false)
        {
            nombreUsuarioAutenticado = usuarioAutenticado.Identity.Name;

            // Obtener el usuario desde el UserManager
            usuarioIdentity = await UserManager.FindByNameAsync(nombreUsuarioAutenticado);

            // Asignar el nombre de usuario al historial de acciones
            historialAcciones.NombrePersona = nombreUsuarioAutenticado;
        }

        await CargarListaBadge();    

        listaUnidades = await unidadControlador.ListarUnidades();

        listaBadge = await badgeControlador.ListarBadge();
        await CargarPagina();

    }

    private async Task seleccionarBadgeEliminar(int eliminarBadges)
    {
        eliminarBadge = listaBadge.FirstOrDefault(x => x.BadgeID == eliminarBadges);
    }

    async Task EliminarBadge(int badgeID)
    {
        await badgeControlador.EliminarBadge(badgeID);

        //Establecer propiedades para historialAcciones de registrar
        historialAcciones.Accion = "Eliminar badge: " + eliminarBadge.BadgeID;
        historialAcciones.Fecha = DateTime.Now;

        await historialAccionesControlador.RegistrarHistorialAcciones(historialAcciones);

        listaBadge = await badgeControlador.ListarBadge();

        StateHasChanged();
    }

    private async Task BusquedaAsincrona(ChangeEventArgs e)
    {
        badgeABuscar = e.Value?.ToString(); // Asegúrate de que se actualice correctamente

        if (int.TryParse(badgeABuscar, out int badgeNumber))
        {
            badgesBuscar = await badgeControlador.BuscarBadgesPorNumero(badgeNumber);
        }
        else
        {
            badgesBuscar.Clear(); // Limpia la lista si el input no es un número válido
        }
    }


    async Task seleccionarEditarBadge(int badgeID)
    {

        actualizarBadge = listaBadge.Find(b => b.BadgeID == badgeID);

        //partir las horas en dos variables para mostrarlas en el formulario
        var horas = actualizarBadge.Horario.Split(simboloRangoHoras);

        badge.Justificacion = actualizarBadge.Justificacion;
        badge.UnidadID = actualizarBadge.UnidadID;
        badge.Horario = actualizarBadge.Horario;
        badge.BadgeID = actualizarBadge.BadgeID;
        badge.Ocupado = actualizarBadge.Ocupado;

        //actualizar la variable horainicio y horafinal para la parte visual cuando se actualiza el badge
        horaInicio = horas[0].Trim();
        horaFinal = horas[1].Trim();
    }

    private async Task ModificarBadge()
    {

        try
        {

            bool exito = false;
            badge.Horario = $"{horaInicio} {simboloRangoHoras} {horaFinal}";

            exito = await badgeControlador.ActualizarBadge(badge);

            listaBadge = await badgeControlador.ListarBadge();


            if (exito)
            {
                mensajeExito = "Badge registrado con éxito.";
                mensajeError = null;

                //Establecer propiedades para historialAcciones de registrar
                historialAcciones.Accion = "Actualizar badge: " + actualizarBadge.Unidad.Nombre + " a " + badge.Unidad.Nombre;
                historialAcciones.Fecha = DateTime.Now;

                await historialAccionesControlador.RegistrarHistorialAcciones(historialAcciones);
            }
            else
            {
                mensajeExito = null;
                mensajeError = "Hubo un problema al registrar el badge.";
            }

        }
        catch (Exception ex)
        {
            mensajeError = $"Error: {ex.Message}";
            mensajeExito = null;
        }

        StateHasChanged();
    }

    private async Task CargarListaBadge()
    {
        listaBadge.Clear();
        //Inicio Listar usuarios que no sean administradores
        listaBadge = await badgeControlador.ListarBadge();
        //filtrar segun el usuario

        //si es usuario regular
        if (usuarioIdentity.UnidadID != null)
        {
            listaBadge = listaBadge.Where(x => x.UnidadID == usuarioIdentity.UnidadID).ToList();
        }
    }

    private async Task OnHorarioChanged(ChangeEventArgs e)
    {
        var horaInicioSeleccionada = e.Value?.ToString();

        if (!string.IsNullOrEmpty(horaInicioSeleccionada))
        {
            horasDelDiaFinal = horasDelDiaCompletas
                .Where(h => string.Compare(h, horaInicioSeleccionada) > 0)
                .ToList();
        }

        horaFinal = horasDelDiaFinal.FirstOrDefault();

        StateHasChanged();

    }

    private bool EsFormularioInvalido()
    {
        return string.IsNullOrEmpty(badge.Justificacion) || string.IsNullOrEmpty(horaInicio) || string.IsNullOrEmpty(horaFinal);
    }

    private async Task CargarPagina()
    {
        var allBadges = await badgeControlador.ListarBadge()/* listaBadge */;
        totalItems = allBadges.Count;
        totalPages = (int)Math.Ceiling(totalItems / (double)pageSize);

        listaBadgePaginacion = allBadges
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();
    }

    private async Task CambiarPagina(int nuevaPagina)
    {
        if (nuevaPagina > 0 && nuevaPagina <= totalPages)
        {
            currentPage = nuevaPagina;
            await CargarPagina();
        }
    }

}
